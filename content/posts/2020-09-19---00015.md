---
title: ãƒ­ãƒ¼ã‚«ãƒ«ã®APIã‚µãƒ¼ãƒã‚’Azure API Managementã«ç™»éŒ²ã™ã‚‹
date: "2020-09-19"
template: "post"
draft: false
slug: "00015"
category: "Azure API Management"
tags:
  - "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å­¦ç¿’"
  - "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°åˆå¿ƒè€…"
description: "æœ¬è¨˜äº‹ã§ã¯ã€AzureãŒæä¾›ã—ã¦ã„ã‚‹API Managementã‚µãƒ¼ãƒ“ã‚¹ã«ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®APIã‚µãƒ¼ãƒã‚’è¿½åŠ ã—ã¦å‹•ä½œç¢ºèªã—ãŸæ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚"
# socialImage: ".../media/image-2.jpg"
---

## å°å…¥

æœ¬è¨˜äº‹ã§ã¯ã€AzureãŒæä¾›ã—ã¦ã„ã‚‹API Managementã‚µãƒ¼ãƒ“ã‚¹ã«ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®APIã‚µãƒ¼ãƒã‚’è¿½åŠ ã—ã¦å‹•ä½œç¢ºèªã—ãŸæ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## ç›®æ¬¡

1. äº‹å‰æº–å‚™
2. ã‚µãƒ³ãƒ—ãƒ«APIã‚µãƒ¼ãƒã®è¨­å®š
   1. ã‚µãƒ³ãƒ—ãƒ«APIã‚µãƒ¼ãƒã‚’ä½œæˆã™ã‚‹
   2. ã‚µãƒ³ãƒ—ãƒ«APIã‚µãƒ¼ãƒã‚’èµ·å‹•ã™ã‚‹
3. ngrokã®è¨­å®š
   1. ngrokã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   2. ngrokã‚’èµ·å‹•ã™ã‚‹
4. OpenAPI Specificationã®ä½œæˆ
5. ã‚µãƒ³ãƒ—ãƒ«APIã®ç™»éŒ²
6. ã‚µãƒ³ãƒ—ãƒ«APIã®ãƒ†ã‚¹ãƒˆ
7. ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ç¢ºèª

## äº‹å‰æº–å‚™

Azure API ManagementãŒåˆ©ç”¨ã§ãã‚‹çŠ¶æ…‹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚  
ã¾ã ã®æ–¹ã¯[ã“ã¡ã‚‰](/posts/00014)ç­‰ã‚’å‚ç…§ã—ã€ç’°å¢ƒã‚’æº–å‚™ã—ã¦ãã ã•ã„ã€‚  

## ã‚µãƒ³ãƒ—ãƒ«APIã‚µãƒ¼ãƒã®è¨­å®š

### ã‚µãƒ³ãƒ—ãƒ«APIã‚µãƒ¼ãƒã‚’ä½œæˆã™ã‚‹

ä»Šå›ã¯[ã“ã¡ã‚‰ã®ãƒ–ãƒ­ã‚°](https://sbfl.net/blog/2018/08/25/nodejs-express-webapi/)ã§ç´¹ä»‹ã—ã¦ã„ã‚‹æ‰‹é †ã§APIã‚µãƒ¼ãƒã‚’ä½œæˆã—ã¾ã—ãŸã€‚  

`http://localhost:3000/api/v1/list`ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€`{"title":"JavaScriptã‚’å‹‰å¼·ã™ã‚‹","done":true}`ãŒè¿”å´ã•ã‚Œã‚‹ç°¡å˜ãªä»•æ§˜ã§ã™ã€‚  

index.jsã®å®Ÿè£…ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚  

``` javascript
// expressãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã‚€
const express = require('express');

// expressã‚¢ãƒ—ãƒªã‚’ç”Ÿæˆã™ã‚‹
const app = express();

// http://localhost:3000/api/v1/list ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ããŸã¨ãã«
// TODOãƒªã‚¹ãƒˆã‚’è¿”ã™
app.get('/api/v1/list', (req, res) => {
    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€ã‚‹JSONãƒ‡ãƒ¼ã‚¿
    const todoList = { title: 'JavaScriptã‚’å‹‰å¼·ã™ã‚‹', done: true };

    // JSONã‚’é€ä¿¡ã™ã‚‹
    res.json(todoList);
});

// ãƒãƒ¼ãƒˆ3000ã§ã‚µãƒ¼ãƒã‚’ç«‹ã¦ã‚‹
app.listen(3000, () => console.log('Listening on port 3000'));
```

### ã‚µãƒ³ãƒ—ãƒ«APIã‚µãƒ¼ãƒã‚’èµ·å‹•ã™ã‚‹

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã™ã‚‹ã¨ã€ã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ›ã‚¹ãƒˆ3000ã§å¾…ã¡å—ã‘çŠ¶æ…‹ã«ãªã‚‹ã®ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèªã—ã¾ã™ã€‚  

``` bash
rui@ruinoMacBook-Pro express-app % node index.js
Listening on port 3000
```

ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚ŒãŸã‚‰ã‚µãƒ³ãƒ—ãƒ«APIã®æº–å‚™ã¯å®Œäº†ã§ã™ã€‚  
APIã‚µãƒ¼ãƒã¯èµ·å‹•ã—ãŸã¾ã¾ã«ã—ã¦ãŠãã¾ã™ã€‚  
![ScreenShot 2020-09-19 18.53.13.png](../media/00015/ScreenShot 2020-09-19 18.53.13.png)

## ngrokã®è¨­å®š

ã‚µãƒ³ãƒ—ãƒ«APIã§ã™ãŒã€ç¾åœ¨ãƒ­ãƒ¼ã‚«ãƒ«ãƒ›ã‚¹ãƒˆã§èµ·å‹•ã—ã¦ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚  
ã—ã‹ã—ã€Azure API Managementã«hostãŒ`localhost`ã¨ãªã‚‹APIã‚’ç™»éŒ²ã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã¾ã™ã€‚  
ã“ã‚Œã¯Azureå†…ã®ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’æŒ‡ã™ã“ã¨ã«ãªã£ã¦ã—ã¾ã†ãŸã‚ã§ã™ã€‚  

ãã“ã§[ngrok](https://ngrok.com/)ã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚  
ngrokã¨ã¯webhookã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®publicURLã‚’ç™ºè¡Œã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚  
>Public URLs for building webhook integrations.
Spend more time programming. One command for an instant, secure URL to your localhost server through any NAT or firewall.  
å¼•ç”¨å…ƒï¼šhttps://ngrok.com/

#### å‚è€ƒè³‡æ–™

- [ngrokã‚’ä½¿ç”¨ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’å¤–éƒ¨ã«å…¬é–‹ã™ã‚‹](https://qiita.com/kitaro0729/items/44214f9f81d3ebda58bd)
- [ngrokã®åˆ©ç”¨æ–¹æ³•](https://qiita.com/hirokisoccer/items/7033c1bb9c85bf6789bd)

### ngrokã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

macã®å ´åˆã€HomebrewãŒå…¥ã£ã¦ã„ã‚Œã°ç°¡å˜ã«å°å…¥ã§ãã¾ã™ã€‚  
â€»Windowsã§ã‚ã‚Œã°zipãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£å‡ã™ã‚‹ã ã‘ã§åˆ©ç”¨ã§ãã¾ã™ã€‚  

`brew install ngrok`  
ã‚³ãƒãƒ³ãƒ‰ã§ã¯ã‚¨ãƒ©ãƒ¼ã¨ãªã£ãŸã®ã§ã€  
`brew cask install ngrok`  
ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚

``` bash
//å®Ÿè¡Œãƒ­ã‚°
rui@ruinoMacBook-Pro ~ % brew install ngrok
Updating Homebrew...
==> Auto-updated Homebrew!
Updated 1 tap (homebrew/core).
==> New Formulae
alsa-lib           dbdeployer         infracost          ladspa-sdk         libirecovery       libseccomp         prometheus-cpp     terrascan          vtk@8.2
==> Updated Formulae
Updated 457 formulae.
==> Renamed Formulae
gst-validate -> gst-devtools

Error: No available formula with the name "ngrok" 
Upstream sunsetted 1.x in March 2016 and 2.x is not open-source.

If you wish to use the 2.x release you can install with Homebrew Cask:
  brew cask install ngrok
rui@ruinoMacBook-Pro ~ % 
rui@ruinoMacBook-Pro ~ % 
rui@ruinoMacBook-Pro ~ % brew cask install ngrok
==> Tapping homebrew/cask
Cloning into '/usr/local/Homebrew/Library/Taps/homebrew/homebrew-cask'...
remote: Enumerating objects: 33, done.
remote: Counting objects: 100% (33/33), done.
remote: Compressing objects: 100% (30/30), done.
remote: Total 480321 (delta 12), reused 7 (delta 3), pack-reused 480288
Receiving objects: 100% (480321/480321), 216.93 MiB | 1.31 MiB/s, done.
Resolving deltas: 100% (340760/340760), done.
Tapped 1 command and 3659 casks (3,776 files, 232.5MB).
==> Downloading https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-darwin-amd64.zip
######################################################################## 100.0%
==> No SHA-256 checksum defined for Cask 'ngrok', skipping verification.
==> Installing Cask ngrok
==> Linking Binary 'ngrok' to '/usr/local/bin/ngrok'.
ğŸº  ngrok was successfully installed!
rui@ruinoMacBook-Pro ~ % 
```

### ngrokã‚’èµ·å‹•ã™ã‚‹

ngrokã‚’èµ·å‹•ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚  
ä»Šå›ã®express APIã‚µãƒ¼ãƒã§ã‚ã‚Œã°3000ãƒãƒ¼ãƒˆã‚’ä½¿ã†ã®ã§ã€ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚  

``` bash
rui@ruinoMacBook-Pro ~ % ngrok http 3000
```

å®Ÿè¡Œã™ã‚‹ã¨ã€ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã®è¡¨ç¤ºãŒä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰ã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚  

![ScreenShot 2020-09-19 19.02.57.png](../media/00015/ScreenShot 2020-09-19 19.02.57.png)

ã“ã®ã†ã¡orwardingã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã¯ã€  
`http://64e22898a87d.ngrok.io`  
ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚Œã°ã€  
`http://localhost:3000`  
ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚  
â€»è»¢é€å‡¦ç†ã‚’ã—ã¦ãã‚Œã¾ã™  

ã“ã®`http://64e22898a87d.ngrok.io`ã‚’Azure API Managementã‚µãƒ¼ãƒ“ã‚¹ã«ç™»éŒ²ã™ã‚‹ã“ã¨ã§ã€ãƒ­ãƒ¼ã‚«ãƒ«ã®APIã‚µãƒ¼ãƒã¨é€šä¿¡ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚  
ngrokã‚‚èµ·å‹•ã—ãŸã¾ã¾ã«ã—ã¦ãŠãã¾ã™ã€‚  

## OpenAPI Specificationã®ä½œæˆ

Azure API Managementã«APIã‚’ç™»éŒ²ã™ã‚‹ãŸã‚ã€OpenAPI Specificationã‚’ä½œæˆã—ã¾ã™ã€‚  
OpenAPI Speficification ã¨ã¯ã€APIã‚’è¨˜è¿°ã™ã‚‹ãŸã‚ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ã“ã¨ã§ã€Open API Initiativeã«ã‚ˆã£ã¦æ¨é€²ã•ã‚Œã¦ã‚‹ã‚ªãƒ¼ãƒ—ãƒ³ãªè¦æ ¼ã§ã™ã€‚  

ã“ã“ã§ã¯è©³ç´°ã¯è¨˜è¼‰ã—ã¾ã›ã‚“ã®ã§ã€ä¸‹è¨˜è³‡æ–™ç­‰ã‚’å‚ç…§ã—ã€ä½œæˆã—ã¦ãã ã•ã„ã€  

#### å‚è€ƒè³‡æ–™

- [OpenAPI (Swagger) è¶…å…¥é–€](https://qiita.com/teinen_qiita/items/e440ca7b1b52ec918f1b)
- [Swaggerã®è¨˜æ³•ã¾ã¨ã‚](https://qiita.com/rllllho/items/53a0023b32f4c0f8eabb)

ä»Šå›ã¯[Swagger UI](https://editor.swagger.io/)ã‚’ä½¿ã£ã¦ä½œæˆã—ã¾ã—ãŸã€‚  
â€»ç™»éŒ²ä¸è¦ã§ä½œæˆã§ãã‚‹ã®ã§ã¨ã¦ã‚‚ä¾¿åˆ©ã§ã™ã€‚  

ä½œæˆã—ãŸOpenAPI Specificationã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚  
ãƒã‚¤ãƒ³ãƒˆã¯hostã« `64e22898a87d.ngrok.io` ã‚’è¨­å®šã—ã¦ã„ã‚‹ç‚¹ã§ã™ã€‚  

``` yaml
swagger: "2.0"
info:
  description: "ã“ã‚Œã¯ã‚µãƒ³ãƒ—ãƒ«APIã§ã™ã€‚"
  version: "1.0.0"
  title: "Sample API"
  termsOfService: "http://swagger.io/terms/"
  contact:
    email: "apiteam@swagger.io"
  license:
    name: "Apache 2.0"
    url: "http://www.apache.org/licenses/LICENSE-2.0.html"
host: "64e22898a87d.ngrok.io"
basePath: "/api/v1"
paths:
  /list:
    get:
      summary: "ã‚µãƒ³ãƒ—ãƒ«API"
      description: "ã‚µãƒ³ãƒ—ãƒ«ã®æƒ…å ±ã‚’è¿”ã—ã¾ã™"
      responses:
        200:
          description: "æˆåŠŸæ™‚ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹"
          schema:
            type: "object"
            properties:
              title:
                type: "string"
                example: "JavaScriptã‚’å‹‰å¼·ã™ã‚‹"
              done:
                type: "boolean"
                example: true
```

## APIã®ç™»éŒ²

ç¶šã„ã¦Azure API Managementã‚µãƒ¼ãƒ“ã‚¹ã«APIã‚’ç™»éŒ²ã—ã¦ã„ãã¾ã™ã€‚  

[Add API] -> [OpenAPI] ã‚’é¸æŠã—ã¾ã™ã€‚  
![ScreenShot 2020-09-19 19.17.01.png](../media/00015/ScreenShot 2020-09-19 19.17.01.png)

[Select a file] ã‹ã‚‰ä¸Šè¨˜ã§ä½œæˆã—ãŸOpenAPI Specificationï¼ˆã“ã“ã§ã¯swagger.yamlï¼‰ã‚’é¸æŠã—ã¾ã™ã€‚  
ä»–ã®è¨­å®šã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã§ã€Œcreateã€ã‚’æŠ¼ä¸‹ã—ã¾ã™ã€‚  
![ScreenShot 2020-09-19 19.17.32.png](../media/00015/ScreenShot 2020-09-19 19.17.32.png)

## APIã®å®Ÿè¡Œ

[Test]ã‚¿ãƒ– -> [ã‚µãƒ³ãƒ—ãƒ«API]ã‚’é¸æŠ -> [Send] ã‚’æŠ¼ä¸‹ã—ã¾ã™ã€‚  
![ScreenShot 2020-09-19 19.21.46.png](../media/00015/ScreenShot 2020-09-19 19.21.46.png)

200ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ããŸã‚‰æˆåŠŸã§ã™ã€‚  
![ScreenShot 2020-09-19 19.23.19.png](../media/00015/ScreenShot 2020-09-19 19.23.19.png)

#### HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹

``` md
HTTP/1.1 200 OK

cache-control: private
content-encoding: gzip
content-type: application/json; charset=utf-8
date: Sat, 19 Sep 2020 10:22:26 GMT
etag: W/"31-utjlEvoAJ2bDixOZRVKHEYHfVpc"
ocp-apim-trace-location: https://apimstrvh1epexidsgscyqls.blob.core.windows.net/apimstbowbjbbkitkmaerfbd-inspector/Aocskp-0vkM0tCpNpfTFBg2-1?sv=2018-03-28&sr=c&sig=0yHVqER3qaUFRDHaWycBph1PD%2Fx9pI0UrHDhnDXpmGY%3D&se=2021-09-19T03%3A00%3A49Z&sp=racwdl&traceId=b7fe4e6a12524ddb838482c55e62e40c
transfer-encoding: chunked
vary: Accept-Encoding,Origin
x-powered-by: Express
{
    "title": "JavaScriptã‚’å‹‰å¼·ã™ã‚‹",
    "done": true
}
```

## ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ç¢ºèª

æ¤œè¨¼ã¨ã—ã¦ã€OpenAPI Specificationã®hostã®å€¤ã‚’  
`64e22898a87d.ngrok.io`  
ã‹ã‚‰  
`localhost:3000`  
ã«å¤‰æ›´ã—ãŸæ™‚ã®æŒ™å‹•ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚  

APIåãŒé‡è¤‡ã™ã‚‹ã®ã§ã€ä¸€åº¦ã€ŒSample APIã€ã¯å‰Šé™¤ã—ã¾ã™ã€‚  
ä¿®æ­£ã—ãŸyamlãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ç™»éŒ²ã—ã¾ã™ã€‚  

åŒæ§˜ã®æ‰‹é †ã§APIã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€500ã‚¨ãƒ©ãƒ¼ã¨ãªã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚  
![ScreenShot 2020-09-19 19.33.39.png](../media/00015/ScreenShot 2020-09-19 19.33.39.png)

#### HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹

``` md
HTTP/1.1 500 Internal Server Error

cache-control: private
content-length: 111
content-type: application/json
date: Sat, 19 Sep 2020 10:33:30 GMT
ocp-apim-trace-location: https://apimstrvh1epexidsgscyqls.blob.core.windows.net/apimstbowbjbbkitkmaerfbd-inspector/Aocskp-0vkM0tCpNpfTFBg2-2?sv=2018-03-28&sr=c&sig=0yHVqER3qaUFRDHaWycBph1PD%2Fx9pI0UrHDhnDXpmGY%3D&se=2021-09-19T03%3A00%3A49Z&sp=racwdl&traceId=67c484097e224d44a1dfa3757fab5679
vary: Origin
{
    "statusCode": 500,
    "message": "Internal server error",
    "activityId": "67c48409-7e22-4d44-a1df-a3757fab5679"
}
```

ä»¥ä¸Šã§æ¤œè¨¼ã¯çµ‚äº†ã§ã™ã€‚  
