{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/00012","result":{"data":{"markdownRemark":{"id":"a92b2f99-9c78-51c8-9eea-45ade96b053c","html":"<h2 id=\"導入\" style=\"position:relative;\"><a href=\"#%E5%B0%8E%E5%85%A5\" aria-label=\"導入 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>導入</h2>\n<p>本記事では、Azure AD B2Cのカスタムポリシーを使い、メールアドレスアカウント（ローカルアカウント）での認証処理を開発していきます。</p>\n<p>手順は<a href=\"https://docs.microsoft.com/ja-jp/azure/active-directory-b2c/custom-policy-get-started#upload-the-policies\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">公式ドキュメント</a>に準じて行なっていきます。</p>\n<h2 id=\"目次\" style=\"position:relative;\"><a href=\"#%E7%9B%AE%E6%AC%A1\" aria-label=\"目次 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>目次</h2>\n<ol>\n<li>\n<p>事前準備</p>\n<ol>\n<li>テナントの作成</li>\n<li>サブスクリプションの設定</li>\n</ol>\n</li>\n<li>\n<p>各種キーの作成</p>\n<ol>\n<li>署名キーの作成</li>\n<li>暗号化キーの作成</li>\n</ol>\n</li>\n<li>\n<p>IdentityExperienceFrameworkアプリケーションの登録</p>\n<ol>\n<li>APIの公開</li>\n</ol>\n</li>\n<li>\n<p>ProxyIdentityExperienceFramework アプリケーションの登録</p>\n<ol>\n<li>APIのアクセス許可を付与</li>\n</ol>\n</li>\n<li>\n<p>カスタムポリシーの設定</p>\n<ol>\n<li>スターターパックを取得</li>\n<li>テナント名を変更</li>\n<li>カスタムポリシーにアプリケーションIDを設定</li>\n</ol>\n</li>\n<li>カスタムポリシーのアップロード</li>\n<li>カスタムポリシーの実行（サインアップ）</li>\n<li>カスタムポリシーの実行（サインイン）</li>\n</ol>\n<h2 id=\"事前準備\" style=\"position:relative;\"><a href=\"#%E4%BA%8B%E5%89%8D%E6%BA%96%E5%82%99\" aria-label=\"事前準備 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>事前準備</h2>\n<h3 id=\"テナントの作成\" style=\"position:relative;\"><a href=\"#%E3%83%86%E3%83%8A%E3%83%B3%E3%83%88%E3%81%AE%E4%BD%9C%E6%88%90\" aria-label=\"テナントの作成 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>テナントの作成</h3>\n<p>AzureADB2Cのテナントが作成されている必要があります。<br>\nテナントの作成方法については<a href=\"/posts/00008\">こちら</a>を参照してください。  </p>\n<h3 id=\"サブスクリプションの設定\" style=\"position:relative;\"><a href=\"#%E3%82%B5%E3%83%96%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E8%A8%AD%E5%AE%9A\" aria-label=\"サブスクリプションの設定 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>サブスクリプションの設定</h3>\n<p>カスタムポリシーを利用するには何らかのサブスクリプションに紐づいている必要があります。<br>\nAzureADB2Cテナントではないディレクトリに移動し、[リソースの追加]から紐付ける設定を行なってください。</p>\n<h2 id=\"azureポータルの設定\" style=\"position:relative;\"><a href=\"#azure%E3%83%9D%E3%83%BC%E3%82%BF%E3%83%AB%E3%81%AE%E8%A8%AD%E5%AE%9A\" aria-label=\"azureポータルの設定 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Azureポータルの設定</h2>\n<p>Azureポータル側の設定を行います。</p>\n<h3 id=\"署名キーの作成\" style=\"position:relative;\"><a href=\"#%E7%BD%B2%E5%90%8D%E3%82%AD%E3%83%BC%E3%81%AE%E4%BD%9C%E6%88%90\" aria-label=\"署名キーの作成 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>署名キーの作成</h3>\n<p>はじめにトークンに署名をするためのキーを作成します。<br>\n[Identity Experience Framework] -> [ポリシー キー] -> [追加] を選択します。<br>\n以下の通り入力し、[作成]を押下します。</p>\n<ul>\n<li>オプション：生成</li>\n<li>名前：TokenSigningKeyContainer</li>\n<li>キーの種類：RSA</li>\n<li>キー使用法：署名</li>\n</ul>\n<p>以下のようなキーが生成されていればOKです。\n<img src=\"../media/00012/ScreenShot%202020-09-17%2022.00.57.png\" alt=\"ScreenShot 2020-09-17 22.00.57.png\"></p>\n<h3 id=\"暗号化キーの作成\" style=\"position:relative;\"><a href=\"#%E6%9A%97%E5%8F%B7%E5%8C%96%E3%82%AD%E3%83%BC%E3%81%AE%E4%BD%9C%E6%88%90\" aria-label=\"暗号化キーの作成 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>暗号化キーの作成</h3>\n<p>続いて暗号化キーを作成します。<br>\n※最終的に取得するトークンは暗号化されていないので、このキーの使い所がわからないのですが、内部処理で使われているようです。  </p>\n<p>署名キーと同様の手順で、以下の通り入力し、[作成]を押下します。</p>\n<ul>\n<li>オプション：生成</li>\n<li>TokenEncryptionKeyContainer</li>\n<li>キーの種類：RSA</li>\n<li>キー使用法：暗号化</li>\n</ul>\n<p>以下のようなキーが生成されていればOKです。\n<img src=\"../media/00012/ScreenShot%202020-09-17%2022.01.05.png\" alt=\"ScreenShot 2020-09-17 22.01.05.png\"></p>\n<h2 id=\"identityexperienceframeworkアプリケーションの登録\" style=\"position:relative;\"><a href=\"#identityexperienceframework%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E7%99%BB%E9%8C%B2\" aria-label=\"identityexperienceframeworkアプリケーションの登録 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>IdentityExperienceFrameworkアプリケーションの登録</h2>\n<p>ローカルアカウント認証のためのアプリケーションを登録します。  </p>\n<p>[アプリの登録] -> [新規登録] を選択します。</p>\n<ul>\n<li>アプリ名：IdentityExperienceFramework</li>\n<li>サポートされているアカウントの種類：この組織のディレクトリ内のアカウントのみ</li>\n<li>リダイレクト URI：[Web] を選択し、「<a href=\"https://your-tenant-name.b2clogin.com/your-tenant-name.onmicrosoft.com\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://your-tenant-name.b2clogin.com/your-tenant-name.onmicrosoft.com</a>」と入力。\nyour-tenant-name は、Azure AD B2C テナント ドメイン名です。</li>\n<li>アクセス許可：[openid と offline_access アクセス許可に対して管理者の同意を付与します] チェック ボックスをオンにする</li>\n</ul>\n<p>上記の通り設定したら [登録] を選択します。<br>\n後の手順で使用するため、アプリケーション (クライアント) ID をコピーしておきます。</p>\n<h3 id=\"apiの公開\" style=\"position:relative;\"><a href=\"#api%E3%81%AE%E5%85%AC%E9%96%8B\" aria-label=\"apiの公開 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>APIの公開</h3>\n<p>ローカルアカウントログインには以下のAPIが必要なようです。<br>\nIdentityExperienceFrameworkアプリの左側のメニューの [管理] -> [API の公開] を選択します。<br>\n[スコープの追加] -> [保存して続行] の順に選択します。既定のアプリケーションID URI をそのまま使用します。<br>\n次の値を入力して、ご自身の Azure AD B2C テナントでカスタム ポリシーの実行を許可するスコープを作成します。  </p>\n<ul>\n<li>スコープ名：user_impersonation</li>\n<li>管理者の同意の表示名：Access IdentityExperienceFramework</li>\n<li>管理者の同意の説明：Allow the application to access IdentityExperienceFramework on behalf of the signed-in user.</li>\n</ul>\n<p><img src=\"../media/00012/ScreenShot%202020-09-16%2020.56.13.png\" alt=\"ScreenShot 2020-09-16 20.56.13.png\"></p>\n<h2 id=\"proxyidentityexperienceframework-アプリケーションの登録\" style=\"position:relative;\"><a href=\"#proxyidentityexperienceframework-%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E7%99%BB%E9%8C%B2\" aria-label=\"proxyidentityexperienceframework アプリケーションの登録 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ProxyIdentityExperienceFramework アプリケーションの登録</h2>\n<p>ローカルアカウント認証のため、もう一つアプリケーションを登録します。  </p>\n<p>[アプリの登録] -> [新規登録] を選択します。</p>\n<ul>\n<li>アプリ名：ProxyIdentityExperienceFramework</li>\n<li>サポートされているアカウントの種類：[この組織のディレクトリ内のアカウントのみ] を選択</li>\n<li>リダイレクト URI：[パブリック クライアント/ネイティブ (モバイルとデスクトップ)] を選択し、[リダイレクト URI] に「myapp://auth」と入力</li>\n<li>アクセス許可：[openid と offline_access アクセス許可に対して管理者の同意を付与します] チェック ボックスをオンにする</li>\n</ul>\n<p>上記の通り設定したら [登録] を選択します。<br>\n後の手順で使用するため、アプリケーション (クライアント) ID をコピーしておきます。</p>\n<h3 id=\"apiのアクセス許可を付与\" style=\"position:relative;\"><a href=\"#api%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E8%A8%B1%E5%8F%AF%E3%82%92%E4%BB%98%E4%B8%8E\" aria-label=\"apiのアクセス許可を付与 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>APIのアクセス許可を付与</h3>\n<p>ProxyIdentityExperienceFrameworkアプリに対して、IdentityExperienceFrameworkアプリが公開しているAPIのアクセス許可を付与します。  </p>\n<p>左側のメニューの [管理] -> [API のアクセス許可] -> [アクセス許可の追加] を選択します。<br>\n[自分の API] タブ -> IdentityExperienceFramework アプリケーション -> [user_impersonation] スコープにチェックを入れる -> [アクセス許可の追加] を選択します。<br>\n[&#x3C;テナント名> に管理者の同意を与えます] を選択します。<br>\n[最新の情報に更新] を選択した後、スコープの [状態] に、“… に付与されました” が表示されることを確認します。　　</p>\n<p><img src=\"../media/00012/ScreenShot%202020-09-16%2020.57.04.png\" alt=\"ScreenShot 2020-09-16 20.57.04.png\"></p>\n<p>user_impersonationの状態に緑のチェックマークがつけばOKです。\n<img src=\"../media/00012/ScreenShot%202020-09-17%2021.57.42.png\" alt=\"ScreenShot 2020-09-17 21.57.42.png\"></p>\n<h2 id=\"カスタムポリシーの設定\" style=\"position:relative;\"><a href=\"#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%83%9D%E3%83%AA%E3%82%B7%E3%83%BC%E3%81%AE%E8%A8%AD%E5%AE%9A\" aria-label=\"カスタムポリシーの設定 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>カスタムポリシーの設定</h2>\n<p>続いてカスタムポリシーとなるxmlファイルを設定していきます。  </p>\n<h3 id=\"スターターパックを取得\" style=\"position:relative;\"><a href=\"#%E3%82%B9%E3%82%BF%E3%83%BC%E3%82%BF%E3%83%BC%E3%83%91%E3%83%83%E3%82%AF%E3%82%92%E5%8F%96%E5%BE%97\" aria-label=\"スターターパックを取得 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>スターターパックを取得</h3>\n<p>AzureADB2CではGitHubでカスタムポリシースターターパックを提供しています。<br>\n<a href=\"https://github.com/Azure-Samples/active-directory-b2c-custom-policy-starterpack/archive/master.zip\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">zipファイル</a>をダウンロードするか、リポジトリをクローンしてください。</p>\n<p>ソースをみるといくつかディレクトリがありますが、LocalAccountsディレクトリ配下のソースを使用していきます。<br>\nVisual Studio Code等でLocalAccountsディレクトリを開いてください。  </p>\n<p>ログインする上で必要となるソースは以下の３ファイルです。　　</p>\n<h4 id=\"trustframeworkbasexml\" style=\"position:relative;\"><a href=\"#trustframeworkbasexml\" aria-label=\"trustframeworkbasexml permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TrustFrameworkBase.xml</h4>\n<p>各Claimの定義やIDプロバイダーの基本情報が定義されています。<br>\n基本的にこのファイルを修正する必要はありません。  </p>\n<h4 id=\"trustframeworkextensionsxml\" style=\"position:relative;\"><a href=\"#trustframeworkextensionsxml\" aria-label=\"trustframeworkextensionsxml permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TrustFrameworkExtensions.xml</h4>\n<p>個人のテナントに依存した項目の設定やUIのカスタム設定、IDプロバイダーを追加する際に更新するファイルです。<br>\nTrustFrameworkBase.xmlを継承しています。  </p>\n<h4 id=\"signuporsigninxml\" style=\"position:relative;\"><a href=\"#signuporsigninxml\" aria-label=\"signuporsigninxml permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SignUpOrSignin.xml</h4>\n<p>ローカルアカウントでのサインイン・サインアップの処理を定義したファイルです。<br>\nTrustFrameworkExtensions.xmlを継承しています。</p>\n<h3 id=\"テナント名を変更\" style=\"position:relative;\"><a href=\"#%E3%83%86%E3%83%8A%E3%83%B3%E3%83%88%E5%90%8D%E3%82%92%E5%A4%89%E6%9B%B4\" aria-label=\"テナント名を変更 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>テナント名を変更</h3>\n<p>LocalAccountsディレクトリのXMLファイルのテナント名が<code class=\"language-text\">yourtenant.onmicrosoft.com</code>となっていますので、<code class=\"language-text\">{自テナント名}.onmicrosoft.com</code>に変更します。  </p>\n<h3 id=\"カスタムポリシーにアプリケーションidを設定\" style=\"position:relative;\"><a href=\"#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%83%9D%E3%83%AA%E3%82%B7%E3%83%BC%E3%81%AB%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3id%E3%82%92%E8%A8%AD%E5%AE%9A\" aria-label=\"カスタムポリシーにアプリケーションidを設定 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>カスタムポリシーにアプリケーションIDを設定</h3>\n<p>上記で登録したIdentityExperienceFrameworkとProxyIdentityExperienceFrameworkのアプリケーションIDをカスタムポリシーに設定します。<br>\nTrustFrameworkExtensions.xmlの４箇所を以下の通り修正します。</p>\n<ul>\n<li>ProxyIdentityExperienceFrameworkAppId -> ProxyIdentityExperienceFrameworkのアプリケーションIDに修正</li>\n<li>IdentityExperienceFrameworkAppId -> IdentityExperienceFrameworkのアプリケーションIDに修正</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ClaimsProvider</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>DisplayName</span><span class=\"token punctuation\">></span></span>Local Account SignIn<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>DisplayName</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TechnicalProfiles</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TechnicalProfile</span> <span class=\"token attr-name\">Id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>login-NonInteractive<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Metadata</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token comment\">&lt;!-- ①ProxyIdentityExperienceFrameworkAppId -> ProxyIdentityExperienceFrameworkのアプリケーションIDに修正 --></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Item</span> <span class=\"token attr-name\">Key</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>client_id<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>ProxyIdentityExperienceFrameworkAppId<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Item</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token comment\">&lt;!-- ②IdentityExperienceFrameworkAppId -> IdentityExperienceFrameworkのアプリケーションIDに修正 --></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Item</span> <span class=\"token attr-name\">Key</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>IdTokenAudience<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>IdentityExperienceFrameworkAppId<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Item</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Metadata</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>InputClaims</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token comment\">&lt;!-- ③ProxyIdentityExperienceFrameworkAppId -> ProxyIdentityExperienceFrameworkのアプリケーションIDに修正 --></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>InputClaim</span> <span class=\"token attr-name\">ClaimTypeReferenceId</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>client_id<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">DefaultValue</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>ProxyIdentityExperienceFrameworkAppId<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n        <span class=\"token comment\">&lt;!-- ④IdentityExperienceFrameworkAppId -> IdentityExperienceFrameworkのアプリケーションIDに修正 --></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>InputClaim</span> <span class=\"token attr-name\">ClaimTypeReferenceId</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>resource_id<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">PartnerClaimType</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>resource<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">DefaultValue</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>IdentityExperienceFrameworkAppId<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>InputClaims</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TechnicalProfile</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TechnicalProfiles</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ClaimsProvider</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<h2 id=\"カスタムポリシーのアップロード\" style=\"position:relative;\"><a href=\"#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%83%9D%E3%83%AA%E3%82%B7%E3%83%BC%E3%81%AE%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89\" aria-label=\"カスタムポリシーのアップロード permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>カスタムポリシーのアップロード</h2>\n<p>[Identity Experience Framework] -> [カスタム ポリシーのアップロード] を選択します。<br>\n次の順序でポリシーファイルをアップロードします。この順序でアップロードしないと継承できないためエラーとなります。  </p>\n<ol>\n<li>TrustFrameworkBase.xml</li>\n<li>TrustFrameworkExtensions.xml</li>\n<li>SignUpOrSignin.xml</li>\n</ol>\n<h2 id=\"カスタムポリシーの実行（サインアップ）\" style=\"position:relative;\"><a href=\"#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%83%9D%E3%83%AA%E3%82%B7%E3%83%BC%E3%81%AE%E5%AE%9F%E8%A1%8C%EF%BC%88%E3%82%B5%E3%82%A4%E3%83%B3%E3%82%A2%E3%83%83%E3%83%97%EF%BC%89\" aria-label=\"カスタムポリシーの実行（サインアップ） permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>カスタムポリシーの実行（サインアップ）</h2>\n<p>[カスタム ポリシー] ページで、<code class=\"language-text\">B2C_1A_signup_signin</code> を選択します。</p>\n<p>[アプリケーションの選択] で、以前に登録した Web アプリケーションを選択、[返信 URL] に <code class=\"language-text\">https://jwt.ms</code> を選択します。<br>\n<code class=\"language-text\">https://jwt.ms</code>が選択肢に表示されなければ、[アプリの登録] -> [以前登録したアプリ名] -> [認証] -> [リダイレクトURI]に設定を追加してください。<br>\nここでは<code class=\"language-text\">sample-express-app</code>というアプリを設定しています。  </p>\n<p>[今すぐ実行] を押下し、カスタムポリシーを実行します。<br>\n<img src=\"../media/00012/ScreenShot%202020-09-17%2021.17.57.png\" alt=\"ScreenShot 2020-09-17 21.17.57png\"></p>\n<p>初回はアカウントがありませんので、サインアップを押下し、新規作成していきます。<br>\n<img src=\"../media/00012/ScreenShot%202020-09-17%2021.18.14.png\" alt=\"ScreenShot 2020-09-17 21.18.14.png\"></p>\n<p>メールアドレス、パスワード、姓名を入力して、[create]を押下してください。\n<code class=\"language-text\">https://jwt.ms</code>の画面が表示されたら成功です。<br>\n<img src=\"../media/00012/ScreenShot%202020-09-17%2021.18.26.png\" alt=\"ScreenShot 2020-09-17 21.18.26.png\"></p>\n<p>クエリ部分に渡されたIDトークンがデコードされ、画面に表示されています。<br>\n<img src=\"../media/00012/ScreenShot%202020-09-17%2021.31.26.png\" alt=\"ScreenShot 2020-09-17 21.31.26.png\"></p>\n<p>画面にIDトークンの内容が表示されない場合は、事前のアプリ作成時にインプリシットフローの設定がされていない可能性があります。<br>\n[アプリの登録] -> [以前登録したアプリ名] -> [認証] -> [暗黙の付与]のアクセストークンとIDトークンにチェックを入れてください。  </p>\n<h2 id=\"カスタムポリシーの実行（サインイン）\" style=\"position:relative;\"><a href=\"#%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%A0%E3%83%9D%E3%83%AA%E3%82%B7%E3%83%BC%E3%81%AE%E5%AE%9F%E8%A1%8C%EF%BC%88%E3%82%B5%E3%82%A4%E3%83%B3%E3%82%A4%E3%83%B3%EF%BC%89\" aria-label=\"カスタムポリシーの実行（サインイン） permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>カスタムポリシーの実行（サインイン）</h2>\n<p>同じ手順で再度カスタムポリシー[B2C<em>1A</em>signup_signin]を実行します。<br>\n先ほど登録したアカウントでログインすると、<code class=\"language-text\">https://jwt.ms</code>の画面が表示されるかと思います。  </p>\n<p>以上で、カスタムポリシーを利用したローカルアカウントの認証処理の実装は完了です。  </p>","fields":{"slug":"/posts/00012","tagSlugs":["/tag/プログラミング学習/","/tag/プログラミング初心者/"]},"frontmatter":{"date":"2020-09-17","description":"本記事では、Azure AD B2Cのカスタムポリシーを使い、メールアドレスアカウント（ローカルアカウント）での認証処理を開発していきます。","tags":["プログラミング学習","プログラミング初心者"],"title":"【Azure AD B2C】カスタムポリシーでメールアドレスログインを行う","socialImage":null}}},"pageContext":{"slug":"/posts/00012"}},"staticQueryHashes":["251939775","3159585216","3942705351","401334301"]}